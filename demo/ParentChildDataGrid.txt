import React, { useState } from "react";
import { DataGrid } from "@mui/x-data-grid";
import { Checkbox, IconButton } from "@mui/material";
import { KeyboardArrowDown, KeyboardArrowUp } from "@mui/icons-material";

const ParentChildDataGrid = () => {
  const [selectedRows, setSelectedRows] = useState({});
  const [expandedRows, setExpandedRows] = useState({});

  const data = [
    {
      groupBy: ["000000025"],
      storeNo: "000000025",
      chain: "0L7856",
      merchantId: "4445017521245",
      tid: "",
      fundingDate: null,
      merchantName: "BST*ATT MOBILITY",
      settlementType: "CD",
      transCount: 1532,
      ttlFeeAmt: 170371.96,
      isLinked: false,
      fundingId: 0,
      id: "000000025",
    },
    {
      storeNo: "000000025",
      chain: "0L7856",
      merchantId: "4445017521245",
      tid: "",
      fundingDate: "2024-08-21",
      merchantName: "BST*ATT MOBILITY",
      settlementType: "CD",
      transCount: 633,
      ttlFeeAmt: 28561.9,
      isLinked: false,
      fundingId: 30373,
      groupBy: ["000000025", "000000025-1"],
      id: "000000025-1",
    },
    {
      storeNo: "000000025",
      chain: "0L7856",
      merchantId: "4445017521245",
      tid: "",
      fundingDate: "2024-08-26",
      merchantName: "BST*ATT MOBILITY",
      settlementType: "CD",
      transCount: 541,
      ttlFeeAmt: 106168.34,
      isLinked: false,
      fundingId: 31239,
      groupBy: ["000000025", "000000025-2"],
      id: "000000025-2",
    },
    {
      storeNo: "000000025",
      chain: "0L7856",
      merchantId: "4445017521245",
      tid: "",
      fundingDate: "2024-08-19",
      merchantName: "BST*ATT MOBILITY",
      settlementType: "CD",
      transCount: 358,
      ttlFeeAmt: 35641.72,
      isLinked: false,
      fundingId: 20093,
      groupBy: ["000000025", "000000025-3"],
      id: "000000025-3",
    },
    {
      groupBy: ["000000121"],
      storeNo: "000000121",
      chain: "0L7856",
      merchantId: "4445017800839",
      tid: "",
      fundingDate: null,
      merchantName: "BST*IRON MOUNTAIN",
      settlementType: "CD",
      transCount: 601,
      ttlFeeAmt: 58617.41,
      isLinked: false,
      fundingId: 0,
      id: "000000121",
    },
    {
      storeNo: "000000121",
      chain: "0L7856",
      merchantId: "4445017800839",
      tid: "",
      fundingDate: "2024-08-21",
      merchantName: "BST*IRON MOUNTAIN",
      settlementType: "CD",
      transCount: 165,
      ttlFeeAmt: 16224.01,
      isLinked: false,
      fundingId: 30377,
      groupBy: ["000000121", "000000121-1"],
      id: "000000121-1",
    },
    {
      storeNo: "000000121",
      chain: "0L7856",
      merchantId: "4445017800839",
      tid: "",
      fundingDate: "2024-08-26",
      merchantName: "BST*IRON MOUNTAIN",
      settlementType: "CD",
      transCount: 210,
      ttlFeeAmt: 19087.32,
      isLinked: false,
      fundingId: 31242,
      groupBy: ["000000121", "000000121-2"],
      id: "000000121-2",
    },
    {
      storeNo: "000000121",
      chain: "0L7856",
      merchantId: "4445017800839",
      tid: "",
      fundingDate: "2024-08-19",
      merchantName: "BST*IRON MOUNTAIN",
      settlementType: "CD",
      transCount: 226,
      ttlFeeAmt: 23306.08,
      isLinked: false,
      fundingId: 20097,
      groupBy: ["000000121", "000000121-3"],
      id: "000000121-3",
    },
    {
      groupBy: ["000001196"],
      storeNo: "000001196",
      chain: "0L7856",
      merchantId: "4445024098715",
      tid: "",
      fundingDate: null,
      merchantName: "BST*SUNBELT RENTALS",
      settlementType: "CD",
      transCount: 23,
      ttlFeeAmt: 8177.06,
      isLinked: false,
      fundingId: 0,
      id: "000001196",
    },
    {
      storeNo: "000001196",
      chain: "0L7856",
      merchantId: "4445024098715",
      tid: "",
      fundingDate: "2024-08-21",
      merchantName: "BST*SUNBELT RENTALS",
      settlementType: "CD",
      transCount: 4,
      ttlFeeAmt: 2535.17,
      isLinked: false,
      fundingId: 30389,
      groupBy: ["000001196", "000001196-1"],
      id: "000001196-1",
    },
    {
      storeNo: "000001196",
      chain: "0L7856",
      merchantId: "4445024098715",
      tid: "",
      fundingDate: "2024-08-26",
      merchantName: "BST*SUNBELT RENTALS",
      settlementType: "CD",
      transCount: 7,
      ttlFeeAmt: 1886.61,
      isLinked: false,
      fundingId: 31244,
      groupBy: ["000001196", "000001196-2"],
      id: "000001196-2",
    },
    {
      storeNo: "000001196",
      chain: "0L7856",
      merchantId: "4445024098715",
      tid: "",
      fundingDate: "2024-08-19",
      merchantName: "BST*SUNBELT RENTALS",
      settlementType: "CD",
      transCount: 12,
      ttlFeeAmt: 3755.28,
      isLinked: false,
      fundingId: 20113,
      groupBy: ["000001196", "000001196-3"],
      id: "000001196-3",
    },
    {
      groupBy: ["000001272"],
      storeNo: "000001272",
      chain: "0L7856",
      merchantId: "4445024736744",
      tid: "",
      fundingDate: null,
      merchantName: "BST*LITTLER MENDELSON",
      settlementType: "CD",
      transCount: 24,
      ttlFeeAmt: 1438.03,
      isLinked: false,
      fundingId: 0,
      id: "000001272",
    },
    {
      storeNo: "000001272",
      chain: "0L7856",
      merchantId: "4445024736744",
      tid: "",
      fundingDate: "2024-08-21",
      merchantName: "BST*LITTLER MENDELSON",
      settlementType: "CD",
      transCount: 1,
      ttlFeeAmt: 12.07,
      isLinked: false,
      fundingId: 30390,
      groupBy: ["000001272", "000001272-1"],
      id: "000001272-1",
    },
    {
      storeNo: "000001272",
      chain: "0L7856",
      merchantId: "4445024736744",
      tid: "",
      fundingDate: "2024-08-26",
      merchantName: "BST*LITTLER MENDELSON",
      settlementType: "CD",
      transCount: 20,
      ttlFeeAmt: 285.74,
      isLinked: false,
      fundingId: 31245,
      groupBy: ["000001272", "000001272-2"],
      id: "000001272-2",
    },
    {
      storeNo: "000001272",
      chain: "0L7856",
      merchantId: "4445024736744",
      tid: "",
      fundingDate: "2024-08-19",
      merchantName: "BST*LITTLER MENDELSON",
      settlementType: "CD",
      transCount: 3,
      ttlFeeAmt: 1140.22,
      isLinked: false,
      fundingId: 20114,
      groupBy: ["000001272", "000001272-3"],
      id: "000001272-3",
    },
    {
      groupBy: ["000002202"],
      storeNo: "000002202",
      chain: "0L7856",
      merchantId: "4445028908079",
      tid: "",
      fundingDate: null,
      merchantName: "BST*RJ WOOLSLAYER",
      settlementType: "CD",
      transCount: 1,
      ttlFeeAmt: 150.78,
      isLinked: false,
      fundingId: 0,
      id: "000002202",
    },
    {
      storeNo: "000002202",
      chain: "0L7856",
      merchantId: "4445028908079",
      tid: "",
      fundingDate: "2024-08-19",
      merchantName: "BST*RJ WOOLSLAYER",
      settlementType: "CD",
      transCount: 1,
      ttlFeeAmt: 150.78,
      isLinked: false,
      fundingId: 20130,
      groupBy: ["000002202", "000002202-1"],
      id: "000002202-1",
    },
    {
      groupBy: ["100002452"],
      storeNo: "100002452",
      chain: "0L7856",
      merchantId: "4445038682555",
      tid: "",
      fundingDate: null,
      merchantName: "BST*FERGUSON ENTERPRISES",
      settlementType: "CD",
      transCount: 1,
      ttlFeeAmt: 208.61,
      isLinked: false,
      fundingId: 0,
      id: "100002452",
    },
    {
      storeNo: "100002452",
      chain: "0L7856",
      merchantId: "4445038682555",
      tid: "",
      fundingDate: "2024-08-21",
      merchantName: "BST*FERGUSON ENTERPRISES",
      settlementType: "CD",
      transCount: 1,
      ttlFeeAmt: 208.61,
      isLinked: false,
      fundingId: 30437,
      groupBy: ["100002452", "100002452-1"],
      id: "100002452-1",
    },
    {
      groupBy: ["100002774"],
      storeNo: "100002774",
      chain: "0L7856",
      merchantId: "4445040096414",
      tid: "",
      fundingDate: null,
      merchantName: "BST*WOLSELEY IND GRP 308",
      settlementType: "CD",
      transCount: 1,
      ttlFeeAmt: 1344.48,
      isLinked: false,
      fundingId: 0,
      id: "100002774",
    },
    {
      storeNo: "100002774",
      chain: "0L7856",
      merchantId: "4445040096414",
      tid: "",
      fundingDate: "2024-08-21",
      merchantName: "BST*WOLSELEY IND GRP 308",
      settlementType: "CD",
      transCount: 1,
      ttlFeeAmt: 1344.48,
      isLinked: false,
      fundingId: 30450,
      groupBy: ["100002774", "100002774-1"],
      id: "100002774-1",
    },
    {
      groupBy: ["100003302"],
      storeNo: "100003302",
      chain: "0L7856",
      merchantId: "4445049768443",
      tid: "",
      fundingDate: null,
      merchantName: "BST*SUNBELT RENTALS 314",
      settlementType: "CD",
      transCount: 94,
      ttlFeeAmt: 16021.25,
      isLinked: false,
      fundingId: 0,
      id: "100003302",
    },
    {
      storeNo: "100003302",
      chain: "0L7856",
      merchantId: "4445049768443",
      tid: "",
      fundingDate: "2024-08-21",
      merchantName: "BST*SUNBELT RENTALS 314",
      settlementType: "CD",
      transCount: 14,
      ttlFeeAmt: 1162.04,
      isLinked: false,
      fundingId: 30469,
      groupBy: ["100003302", "100003302-1"],
      id: "100003302-1",
    },
    {
      storeNo: "100003302",
      chain: "0L7856",
      merchantId: "4445049768443",
      tid: "",
      fundingDate: "2024-08-19",
      merchantName: "BST*SUNBELT RENTALS 314",
      settlementType: "CD",
      transCount: 47,
      ttlFeeAmt: 9816.54,
      isLinked: false,
      fundingId: 20174,
      groupBy: ["100003302", "100003302-2"],
      id: "100003302-2",
    },
    {
      storeNo: "100003302",
      chain: "0L7856",
      merchantId: "4445049768443",
      tid: "",
      fundingDate: "2024-08-26",
      merchantName: "BST*SUNBELT RENTALS 314",
      settlementType: "CD",
      transCount: 33,
      ttlFeeAmt: 5042.67,
      isLinked: false,
      fundingId: 31279,
      groupBy: ["100003302", "100003302-3"],
      id: "100003302-3",
    },
    {
      groupBy: ["100003443"],
      storeNo: "100003443",
      chain: "0L7856",
      merchantId: "4445056682347",
      tid: "",
      fundingDate: null,
      merchantName: "BST*FERGUSON ENTERPRISES",
      settlementType: "CD",
      transCount: 473,
      ttlFeeAmt: 101976.97,
      isLinked: false,
      fundingId: 0,
      id: "100003443",
    },
    {
      storeNo: "100003443",
      chain: "0L7856",
      merchantId: "4445056682347",
      tid: "",
      fundingDate: "2024-08-21",
      merchantName: "BST*FERGUSON ENTERPRISES",
      settlementType: "CD",
      transCount: 132,
      ttlFeeAmt: 12658.56,
      isLinked: false,
      fundingId: 30472,
      groupBy: ["100003443", "100003443-1"],
      id: "100003443-1",
    },
    {
      storeNo: "100003443",
      chain: "0L7856",
      merchantId: "4445056682347",
      tid: "",
      fundingDate: "2024-08-19",
      merchantName: "BST*FERGUSON ENTERPRISES",
      settlementType: "CD",
      transCount: 145,
      ttlFeeAmt: 40236.32,
      isLinked: false,
      fundingId: 20178,
      groupBy: ["100003443", "100003443-2"],
      id: "100003443-2",
    },
    {
      storeNo: "100003443",
      chain: "0L7856",
      merchantId: "4445056682347",
      tid: "",
      fundingDate: "2024-08-26",
      merchantName: "BST*FERGUSON ENTERPRISES",
      settlementType: "CD",
      transCount: 196,
      ttlFeeAmt: 49082.09,
      isLinked: false,
      fundingId: 31283,
      groupBy: ["100003443", "100003443-3"],
      id: "100003443-3",
    },
    {
      groupBy: ["100003582"],
      storeNo: "100003582",
      chain: "0L7856",
      merchantId: "4445057189987",
      tid: "",
      fundingDate: null,
      merchantName: "BST*FERGUSON ENTERPRISES",
      settlementType: "CD",
      transCount: 39,
      ttlFeeAmt: 2874.99,
      isLinked: false,
      fundingId: 0,
      id: "100003582",
    },
    {
      storeNo: "100003582",
      chain: "0L7856",
      merchantId: "4445057189987",
      tid: "",
      fundingDate: "2024-08-21",
      merchantName: "BST*FERGUSON ENTERPRISES",
      settlementType: "CD",
      transCount: 11,
      ttlFeeAmt: 812.34,
      isLinked: false,
      fundingId: 30477,
      groupBy: ["100003582", "100003582-1"],
      id: "100003582-1",
    },
    {
      storeNo: "100003582",
      chain: "0L7856",
      merchantId: "4445057189987",
      tid: "",
      fundingDate: "2024-08-19",
      merchantName: "BST*FERGUSON ENTERPRISES",
      settlementType: "CD",
      transCount: 12,
      ttlFeeAmt: 1617.47,
      isLinked: false,
      fundingId: 20181,
      groupBy: ["100003582", "100003582-2"],
      id: "100003582-2",
    },
    {
      storeNo: "100003582",
      chain: "0L7856",
      merchantId: "4445057189987",
      tid: "",
      fundingDate: "2024-08-26",
      merchantName: "BST*FERGUSON ENTERPRISES",
      settlementType: "CD",
      transCount: 16,
      ttlFeeAmt: 445.18,
      isLinked: false,
      fundingId: 31287,
      groupBy: ["100003582", "100003582-3"],
      id: "100003582-3",
    },
    {
      groupBy: ["100004391"],
      storeNo: "100004391",
      chain: "0L7856",
      merchantId: "4445061742730",
      tid: "",
      fundingDate: null,
      merchantName: "BST*FARMER BROS",
      settlementType: "CD",
      transCount: 133,
      ttlFeeAmt: 3879.84,
      isLinked: false,
      fundingId: 0,
      id: "100004391",
    },
    {
      storeNo: "100004391",
      chain: "0L7856",
      merchantId: "4445061742730",
      tid: "",
      fundingDate: "2024-08-21",
      merchantName: "BST*FARMER BROS",
      settlementType: "CD",
      transCount: 65,
      ttlFeeAmt: 1778.17,
      isLinked: false,
      fundingId: 30515,
      groupBy: ["100004391", "100004391-1"],
      id: "100004391-1",
    },
    {
      storeNo: "100004391",
      chain: "0L7856",
      merchantId: "4445061742730",
      tid: "",
      fundingDate: "2024-08-19",
      merchantName: "BST*FARMER BROS",
      settlementType: "CD",
      transCount: 28,
      ttlFeeAmt: 1027.56,
      isLinked: false,
      fundingId: 20217,
      groupBy: ["100004391", "100004391-2"],
      id: "100004391-2",
    },
    {
      storeNo: "100004391",
      chain: "0L7856",
      merchantId: "4445061742730",
      tid: "",
      fundingDate: "2024-08-26",
      merchantName: "BST*FARMER BROS",
      settlementType: "CD",
      transCount: 40,
      ttlFeeAmt: 1074.11,
      isLinked: false,
      fundingId: 31322,
      groupBy: ["100004391", "100004391-3"],
      id: "100004391-3",
    },
    {
      groupBy: ["101"],
      storeNo: "101",
      chain: "0L7856",
      merchantId: "4445017773879",
      tid: null,
      fundingDate: null,
      merchantName: "BST*ROBERT HALF INTL",
      settlementType: "CD",
      transCount: 33,
      ttlFeeAmt: 4920.48,
      isLinked: false,
      fundingId: 0,
      id: "101",
    },
    {
      storeNo: "101",
      chain: "0L7856",
      merchantId: "4445017773879",
      tid: null,
      fundingDate: "2024-08-02",
      merchantName: "BST*ROBERT HALF INTL",
      settlementType: "CD",
      transCount: 33,
      ttlFeeAmt: 4920.48,
      isLinked: false,
      fundingId: 66,
      groupBy: ["101", "101-1"],
      id: "101-1",
    },
    {
      groupBy: ["115"],
      storeNo: "115",
      chain: "0L7856",
      merchantId: "4445017798744",
      tid: null,
      fundingDate: null,
      merchantName: "BST*NOCO ENERGY",
      settlementType: "CD",
      transCount: 1,
      ttlFeeAmt: 3.9,
      isLinked: false,
      fundingId: 0,
      id: "115",
    },
    {
      storeNo: "115",
      chain: "0L7856",
      merchantId: "4445017798744",
      tid: null,
      fundingDate: "2024-08-12",
      merchantName: "BST*NOCO ENERGY",
      settlementType: "CD",
      transCount: 1,
      ttlFeeAmt: 3.9,
      isLinked: false,
      fundingId: 67,
      groupBy: ["115", "115-1"],
      id: "115-1",
    },
    {
      groupBy: ["18"],
      storeNo: "18",
      chain: "07710E",
      merchantId: "4445032646366",
      tid: null,
      fundingDate: null,
      merchantName: "BST*UNITED PARCEL 316",
      settlementType: "CD",
      transCount: 20,
      ttlFeeAmt: 910.37,
      isLinked: false,
      fundingId: 0,
      id: "18",
    },
    {
      storeNo: "18",
      chain: "07710E",
      merchantId: "4445032646366",
      tid: null,
      fundingDate: "2024-08-12",
      merchantName: "BST*UNITED PARCEL 316",
      settlementType: "CD",
      transCount: 5,
      ttlFeeAmt: 266.79,
      isLinked: false,
      fundingId: 61,
      groupBy: ["18", "18-1"],
      id: "18-1",
    },
    {
      storeNo: "18",
      chain: "07710E",
      merchantId: "4445032646366",
      tid: null,
      fundingDate: "2024-08-12",
      merchantName: "BST*UNITED PARCEL 316",
      settlementType: "CD",
      transCount: 5,
      ttlFeeAmt: 266.79,
      isLinked: false,
      fundingId: 62,
      groupBy: ["18", "18-2"],
      id: "18-2",
    },
    {
      storeNo: "18",
      chain: "07710E",
      merchantId: "4445032646366",
      tid: null,
      fundingDate: "2024-08-07",
      merchantName: "BST*UNITED PARCEL 316",
      settlementType: "CD",
      transCount: 5,
      ttlFeeAmt: 266.79,
      isLinked: false,
      fundingId: 63,
      groupBy: ["18", "18-3"],
      id: "18-3",
    },
    {
      storeNo: "18",
      chain: "07710E",
      merchantId: "4445032646366",
      tid: null,
      fundingDate: "2024-08-15",
      merchantName: "BST*UNITED PARCEL 316",
      settlementType: "CD",
      transCount: 5,
      ttlFeeAmt: 110,
      isLinked: false,
      fundingId: 64,
      groupBy: ["18", "18-4"],
      id: "18-4",
    },
    {
      groupBy: ["40"],
      storeNo: "40",
      chain: "0L7856",
      merchantId: "4445014423269",
      tid: null,
      fundingDate: null,
      merchantName: "BST*ARAMARK UNIFORM SVCS",
      settlementType: "CD",
      transCount: 146,
      ttlFeeAmt: 4700,
      isLinked: false,
      fundingId: 0,
      id: "40",
    },
    {
      storeNo: "40",
      chain: "0L7856",
      merchantId: "4445014423269",
      tid: null,
      fundingDate: "2024-08-15",
      merchantName: "BST*ARAMARK UNIFORM SVCS",
      settlementType: "CD",
      transCount: 146,
      ttlFeeAmt: 4700,
      isLinked: false,
      fundingId: 65,
      groupBy: ["40", "40-1"],
      id: "40-1",
    },
  ];

   // Group rows by the first item in groupBy
  const groupedData = data.reduce((acc, row) => {
    const groupId = row.groupBy[0];
    if (!acc[groupId]) {
      acc[groupId] = [];
    }
    acc[groupId].push(row);
    return acc;
  }, {});

  // Column definitions
  const columns = [
    {
      field: "expand",
      headerName: "",
      width: 50,
      renderCell: (params) => {
        const isParent = params.row.groupBy.length === 1;
        return isParent ? (
          <IconButton
            onClick={() => toggleRowExpansion(params.row.id)}
            aria-label="expand row"
            size="small"
          >
            {expandedRows[params.row.id] ? (
              <KeyboardArrowUp />
            ) : (
              <KeyboardArrowDown />
            )}
          </IconButton>
        ) : null;
      },
    },
    { field: "id", headerName: "ID", flex: 1 },
    { field: "chain", headerName: "Chain", flex: 1 },
    { field: "merchantId", headerName: "MID", flex: 1 },
    { field: "merchantName", headerName: "DBAName", flex: 1.8 },
    { field: "settlementType", headerName: "SettleType", flex: 1 },
    {
      field: "fundingDate",
      headerName: "FundingDate",
      flex: 1.3,
      type: "date",
      valueGetter: (params) => new Date(params),
    },
    {
      field: "transCount",
      headerName: "TxnCnt",
      flex: 1,
      cellClassName: "align-right",
    },
    {
      field: "ttlFeeAmt",
      headerName: "TotalMonthEndFee",
      flex: 1.3,
      cellClassName: "align-right",
      type: "number",
    },
    { field: "fundingId", headerName: "Funding Id", flex: 1 },
    { field: "storeNo", headerName: "Store Number", flex: 1 },
  ];

  const toggleRowExpansion = (rowId) => {
    setExpandedRows((prev) => ({
      ...prev,
      [rowId]: !prev[rowId],
    }));
  };

  const onSelectionModelChange = (newSelectionModel) => {
    const newSelection = new Set(newSelectionModel);

    const updatedSelection = new Set(newSelectionModel);

    const selectedRows = data.filter((row) => newSelection.has(row.id));
    data.forEach((row) => {
      // If a parent row is selected, add all its children
      if (row.groupBy.length === 1 && newSelectionSet.has(row.id)) {
        data.forEach((child) => {
          if (child.groupBy.includes(row.id)) {
            updatedSelectionSet.add(child.id);
          }
        });
      }
    });

    setSelectionModel(Array.from(updatedSelection));
  };

  const getVisibleRows = () => {
    let visibleRows = [];
    Object.values(groupedData).forEach((rows) => {
      // Sort rows: parent rows first, then child rows
      rows
        .sort((a, b) => {
          return (
            a.groupBy.length - b.groupBy.length || a.id.localeCompare(b.id)
          );
        })
        .forEach((row) => {
          if (row.groupBy.length === 1 || expandedRows[row.groupBy[0]]) {
            visibleRows.push(row);
          }
        });
    });
    return visibleRows;
  };

  return (
    <div style={{ height: 400, width: "100%" }}>
      <DataGrid
        rows={getVisibleRows()}
        columns={columns}
        pageSizeOptions={[5, 10]}
        checkboxSelection
        onSelectionModelChange={onSelectionModelChange}
        selectionModel={selectionModel}
        disableRowSelectionOnClick
      />
    </div>
  );
};

export default ParentChildDataGrid;
